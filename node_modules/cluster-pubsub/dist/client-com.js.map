{"version":3,"sources":["../src/client-com.es6"],"names":[],"mappings":"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","file":"client-com.es6","sourcesContent":["import EventEmitter from 'events';\nimport crypto from 'crypto';\nimport Loki from 'lokijs';\nimport exitHook from 'exit-hook';\nimport fs from 'fs';\n\nconst dbFile = 'accepted.cache.json';\n\nexport default class ClientCom extends EventEmitter {\n  constructor(debug = true) {\n    super();\n\n    const db = new Loki();\n\n    const accepted = db.addCollection('accepted');\n\n    this.debug = debug;\n    this.accepted = accepted;\n    this.on('error', err => console.error(err));\n\n    this._restore();\n\n    exitHook(() => this._dump());\n  }\n\n  _restore() {\n    try {\n      const res = JSON.parse(fs.readFileSync(dbFile, 'utf8'));\n\n      this.accepted.insert(...res);\n    } catch (e) {\n      // ignore\n    }\n  }\n\n  _dump() {\n    const res = this.accepted.find();\n\n    try {\n      fs.writeFileSync(dbFile, JSON.stringify(res), 'utf8');\n    } catch (e) {\n      // ignore\n    }\n  }\n\n  // privatizing\n  _emit(...args) {\n    return super.emit(...args);\n  }\n\n  tokens() {\n    let tokens = [];\n\n    for (const [, toks] of Object.entries(this.origins)) {\n      tokens = tokens.concat(toks);\n    }\n  }\n\n  accept(origin, token) {\n    let res = this.accepted.findOne({token, origin});\n\n    if (!res) {\n      const uuid = crypto.randomBytes(20).toString('hex');\n\n      // TODO ensure unique\n      res = this.accepted.insert({origin, token, uuid});\n    }\n\n    return res.uuid;\n  }\n\n  isAccepted(uuid) {\n    const res = this.accepted.findOne({uuid});\n    return res && res.uuid;\n  }\n\n  originOf(uuid) {\n    const res = this.accepted.findOne({uuid});\n    return res;\n  }\n\n  uuidOf(origin, token) {\n    origin = origin || '<stopper>';\n    token = token || '<stopper>';\n\n    const res = this.accepted.findOne({token, origin});\n\n    return res && res.uuid;\n  }\n\n  reject(origin, token) {\n    const res = this.accepted.findOne({token, origin});\n\n    try {\n      this.accepted.remove(res);\n\n      return res.uuid;\n    } catch (e) {\n      // ignore\n    }\n  }\n\n  log(...args) {\n    if (this.debug) {\n      console.log(...args);\n    }\n  }\n\n  attach(server) {\n    throw new Error('Not implemented', server);\n  }\n\n  emit(origin, token, channel, data) {\n    throw new Error('Not implemented', origin, channel, token, data);\n  }\n\n  broadcast(origin, channel, data) {\n    throw new Error('Not implemented', origin, channel, data);\n  }\n}\n"]}